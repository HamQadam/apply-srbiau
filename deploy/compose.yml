services:
  api:
    build:
      context: ../backend
    container_name: apply-api
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_HOST: database
      SMS_IR_API_KEY: ${SMS_IR_API_KEY}
      SMS_IR_TEMPLATE_ID: ${SMS_IR_TEMPLATE_ID}
      DEBUG_OTP: ${DEBUG_OTP}
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID} 
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET} 
    env_file:
      - ../.env
    volumes:
      - uploads:/app/uploads
    depends_on:
      database:
        condition: service_healthy
    restart: unless-stopped
    expose:
      - "8888"   # internal only
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8888/health').read()"]
      interval: 5s
      timeout: 3s
      retries: 30

  frontend:
    build:
      context: ../frontend
    container_name: apply-frontend
    environment:
      VITE_GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
    restart: unless-stopped
    expose:
      - "80"     # internal only


  # ─────────────────────────────────────────────────────────────
  # DAAD Crawler (Germany)
  # ─────────────────────────────────────────────────────────────
  daad-crawler:
    build: ../crawlers
    command: ["daad"]
    profiles: ["crawlers", "all-crawlers"]
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-apply_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-apply_secret}
      POSTGRES_DB: ${POSTGRES_DB:-apply_db}
      POSTGRES_HOST: database
      POSTGRES_PORT: 5432
      BATCH_SIZE: 50
      DAAD_RPS: 2.0
      DB_WAIT_TIMEOUT_S: 180
    volumes:
      - crawler-state:/state
    depends_on:
      api:
        condition: service_healthy
      database:
        condition: service_healthy
    restart: "no"

  # ─────────────────────────────────────────────────────────────
  # StudyInNL Crawler (Netherlands)
  # ─────────────────────────────────────────────────────────────
  studyinnl-crawler:
    build: ../crawlers
    command: ["studyinnl"]
    profiles: ["crawlers", "all-crawlers"]
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-apply_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-apply_secret}
      POSTGRES_DB: ${POSTGRES_DB:-apply_db}
      POSTGRES_HOST: database
      POSTGRES_PORT: 5432
      BATCH_SIZE: 50
      STUDYINNL_RPS: 2.0
      DB_WAIT_TIMEOUT_S: 180
    volumes:
      - crawler-state:/state
    depends_on:
      api:
        condition: service_healthy
      database:
        condition: service_healthy
    restart: "no"

  database:
    image: postgres:16
    container_name: apply-db
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
      PGDATA: /data/postgres
    ports:
      - 127.0.0.1:5432:5432
    env_file:
      - ../.env
    volumes:
      - db:/data/postgres
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  nginx:
    image: nginx:alpine
    container_name: apply-edge
    depends_on:
      - api
      - frontend
    ports:
      - "80:80"
      # later when you add TLS:
      # - "443:443"
    volumes:
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
    restart: unless-stopped


  # ─────────────────────────────────────────────────────────────
  # Post-process: Deadline Refiner (rules-first, LLM fallback)
  # ─────────────────────────────────────────────────────────────
  deadline-refiner:
    build: ../postprocess
    command: ["run", "deadlines", "--batch-size", "200", "--max-rows", "50000"]
    profiles: ["postprocess", "all-postprocess"]
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER:-apply_user}:${POSTGRES_PASSWORD:-apply_secret}@database:5432/${POSTGRES_DB:-apply_db}
      TABLE_NAME: public.courses
      ID_COLUMN: id
      NOTES_COLUMN: deadline_notes
      FALL_COLUMN: deadline_fall
      SPRING_COLUMN: deadline_spring
      LOCK_ROWS: "true"
      LLM_ENABLED: ${LLM_ENABLED:-true}
      LLM_MODEL_PATH: /models/Phi-3-mini-4k-instruct-q4.gguf
      LLM_CTX: ${LLM_CTX:-1024}
      LLM_BATCH: ${LLM_BATCH:-128}
      LLM_THREADS: ${LLM_THREADS:-8}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    volumes:
      - ./models:/models:ro
    depends_on:
      api:
        condition: service_healthy
      database:
        condition: service_healthy
    restart: "no"


volumes:
  db:
  uploads:
  daad_state:
